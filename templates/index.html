<!DOCTYPE html>
<html>
  <head>
    <title>RAG å‚™å¯©è³‡æ–™ç³»çµ±</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link
      rel="stylesheet"
      type="text/css"
      href="{{ url_for('static', filename='style.css') }}"
    />
  </head>

  <body>
    <h1>RAG å‚™å¯©è³‡æ–™ç³»çµ±</h1>

    <h3>é¸æ“‡å­¸æ ¡ & å­¸ç³»</h3>
    <select id="university"></select>
    <select id="department"></select>
    <button onclick="loadGuidelines()">ç¢ºèª</button>

    <h3>ğŸ“„ æ¬²ç”Ÿæˆæ®µè½</h3>
    <select id="section_code" onchange="updateFieldsBasedOnSelection()">
      <option value="ABC">èª²ç¨‹å­¸ç¿’æˆæœ</option>
      <option value="N">å¤šå…ƒè¡¨ç¾ç¶œæ•´</option>
      <option value="O">å­¸ç¿’æ­·ç¨‹åæ€</option>
      <option value="P">å­¸ç¿’å‹•æ©Ÿ</option>
      <option value="Q">æœªä¾†è¨ˆç•«</option>
    </select>

    <h3>ğŸ“Œè«‹åˆ†åˆ¥å¡«å¯«å„é …ç›®å…§å®¹</h3>
    <div id="fields"></div>

    <h3>ğŸ“å ±å‘Šé¢¨æ ¼</h3>
    <select id="style">
      <option value="formal">æ­£å¼</option>
      <option value="casual">å£èª</option>
      <option value="concise">ç°¡æ½”</option>
      <option value="detailed">æ·±å…¥åˆ†æ</option>
    </select>

    <button onclick="generateParagraph()">ç”Ÿæˆ</button>
    <div id="loading-overlay">
      <div id="loading-spinner">
        <div id="spinner-icon"></div>
        <!-- é€™æ˜¯è½‰åœˆåœˆ -->
        â³ å…§å®¹ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...
      </div>
    </div>

    <h3>ğŸ“„ ç”Ÿæˆçµæœ</h3>
    <div id="test_parameters"></div>
    <div id="output"></div>
    <script>
      let schoolData = {};
      let SECTION_MAPPING = {
        ABC: { codes: ["A", "B", "C", "D", "E"] },
        N: { codes: ["F", "G", "H", "I", "J", "K", "L", "M"] },
        O: {
          codes: [
            "A",
            "B",
            "C",
            "D",
            "E",
            "F",
            "G",
            "H",
            "I",
            "J",
            "K",
            "L",
            "M",
          ],
        },
        P: {
          codes: [
            "A",
            "B",
            "C",
            "D",
            "E",
            "F",
            "G",
            "H",
            "I",
            "J",
            "K",
            "L",
            "M",
          ],
        },
        Q: {
          codes: [
            "A",
            "B",
            "C",
            "D",
            "E",
            "F",
            "G",
            "H",
            "I",
            "J",
            "K",
            "L",
            "M",
          ],
        },
      };

      // è¼‰å…¥å­¸æ ¡
      function loadUniversities() {
        $.get("/get_schools_departments", function (data) {
          schoolData = data;
          $("#university")
            .empty()
            .append('<option value="">è«‹é¸æ“‡å­¸æ ¡</option>');
          for (let uni in data) {
            $("#university").append(`<option value="${uni}">${uni}</option>`);
          }
        });
      }

      // è¼‰å…¥è©²å­¸æ ¡çš„å­¸ç³»ï¼ˆç›´æ¥å¾ schoolData å–å¾—ï¼‰
      function loadDepartments() {
        let university = $("#university").val();
        $("#department").empty().append('<option value="">è«‹é¸æ“‡å­¸ç³»</option>');

        if (university && schoolData[university]) {
          for (let dept of schoolData[university]) {
            $("#department").append(`<option value="${dept}">${dept}</option>`);
          }
        }
      }

      // ç¢ºèªå­¸ç³»å¾Œè¼‰å…¥è©²å­¸ç³»çš„å‚™å¯©è³‡æ–™
      function loadGuidelines() {
        let university = $("#university").val();
        let department = $("#department").val();

        if (!university || !department) {
          alert("è«‹é¸æ“‡å­¸æ ¡èˆ‡å­¸ç³»ï¼");
          return;
        }

        $.ajax({
          url: "/get_guidelines",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify({ university, department }),
          dataType: "json",
          success: function (data) {
            if (!data.sections) {
              alert("è©²å­¸ç³»ç›®å‰æ²’æœ‰å‚™å¯©è³‡æ–™ï¼");
              return;
            }

            // åªä¿ç•™è©²å­¸ç³»çš„è¦æ±‚å…§å®¹ï¼ˆ`section code`ï¼‰
            SECTION_MAPPING = {};
            for (let sectionCode in data.sections) {
              if (["ABC", "N", "O", "P", "Q"].includes(sectionCode)) {
                SECTION_MAPPING[sectionCode] = {
                  codes: data.sections[sectionCode].codes || [],
                  loaded_content: data.sections[sectionCode].content,
                };
              }
            }

            updateFieldsBasedOnSelection();
          },
          error: function () {
            alert("è¼‰å…¥å‚™å¯©è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥å­¸æ ¡èˆ‡å­¸ç³»æ˜¯å¦æ­£ç¢ºï¼");
          },
        });
      }

      // æ›´æ–°å¯è¼¸å…¥çš„æ¬„ä½
      function updateFieldsBasedOnSelection() {
        let sectionCode = document.getElementById("section_code").value;
        let fieldsDiv = document.getElementById("fields");
        fieldsDiv.innerHTML = "";

        if (SECTION_MAPPING.hasOwnProperty(sectionCode)) {
          let sectionData = SECTION_MAPPING[sectionCode];

          sectionData.codes.forEach((code) => {
            let label = document.createElement("label");
            label.innerHTML = `<strong>${code} - ${getCodeName(code)}</strong>`;
            label.style.display = "block";
            fieldsDiv.appendChild(label);

            let textarea = document.createElement("textarea");
            textarea.id = `input_${code}`;
            textarea.rows = 5;
            textarea.cols = 50;
            textarea.maxLength = 300;
            textarea.addEventListener("input", () => updateCharCount(textarea));

            let charCount = document.createElement("div");
            charCount.id = `charCount_${code}`;
            charCount.innerHTML = `å‰©é¤˜å­—æ•¸: <span>${textarea.maxLength}</span>`;

            fieldsDiv.appendChild(textarea);
            fieldsDiv.appendChild(charCount);
            fieldsDiv.appendChild(document.createElement("br"));
          });
        }
      }

      function updateCharCount(textarea) {
        let maxLength = textarea.maxLength;
        let currentLength = textarea.value.length;
        let remaining = maxLength - currentLength;

        let charCountDiv = document.getElementById(
          `charCount_${textarea.id.split("_")[1]}`
        );
        if (charCountDiv) {
          charCountDiv.innerHTML = `å‰©é¤˜å­—æ•¸: <span>${remaining}</span>`;
        }
      }

      function getCodeName(code) {
        const CODE_MAPPING = {
          A: "ä¿®èª²ç´€éŒ„",
          B: "æ›¸é¢å ±å‘Š",
          C: "å¯¦ä½œä½œå“",
          D: "è‡ªç„¶ç§‘å­¸æ¢ç©¶",
          E: "ç¤¾æœƒé ˜åŸŸæ¢ç©¶",
          F: "é«˜ä¸­è‡ªä¸»å­¸ç¿’è¨ˆç•«",
          G: "ç¤¾åœ˜æ´»å‹•ç¶“é©—",
          H: "å¹¹éƒ¨ç¶“é©—",
          I: "æœå‹™å­¸ç¿’ç¶“é©—",
          J: "ç«¶è³½è¡¨ç¾",
          K: "éä¿®èª²æˆæœä½œå“",
          L: "æª¢å®šè­‰ç…§",
          M: "ç‰¹æ®Šå„ªè‰¯è¡¨ç¾",
          N: "å¤šå…ƒè¡¨ç¾ç¶œæ•´å¿ƒå¾—",
          O: "é«˜ä¸­å­¸ç¿’æ­·ç¨‹åæ€",
          P: "å­¸ç¿’å‹•æ©Ÿ",
          Q: "æœªä¾†å­¸ç¿’è¨ˆç•«",
        };
        return CODE_MAPPING[code] || "æœªçŸ¥é …ç›®";
      }

      function generateParagraph() {
        let university = $("#university").val();
        let department = $("#department").val();
        let sectionCode = $("#section_code").val();
        let style = $("#style").val();
        let userInputs = {};

        $("textarea").each(function () {
          if ($(this).val().trim() !== "") {
            let code = this.id.replace("input_", "");
            userInputs[code] = $(this).val();
          }
        });

        if (!sectionCode) {
          alert("è«‹é¸æ“‡è¦ç”Ÿæˆçš„æ®µè½");
          return;
        }

        $("#loading-overlay").show();
        $("#output").empty();

        $.post(
          "/generate_paragraph",
          JSON.stringify({
            university,
            department,
            section_code: sectionCode,
            user_inputs: userInputs,
            style,
          }),
          function (data) {
            $("#loading-overlay").hide();
            $("#test_parameters").html(`
              <p>ğŸ”¹ ç”Ÿæˆæ¬¡æ•¸: <strong>${data.generation_steps}</strong></p>
              <p>ğŸ”¹ é¢¨æ ¼: <strong>${data.style}</strong></p>
              <p>ğŸ”¹ èª¿æ•´ç¨‹åº¦: <strong>${data.adjust_percentage}%</strong></p>
            `);
            $("#output").text(data.generated_text);
          },
          "json"
        ).fail(function () {
          $("#loading-overlay").hide();
          alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ï¼");
        });
      }

      // ç¶å®šäº‹ä»¶
      $(document).ready(function () {
        loadUniversities();

        $("#university").change(loadDepartments);
        $("#department").change(loadGuidelines);
        $("#section_code").change(updateFieldsBasedOnSelection);
      });
    </script>
  </body>
</html>
