{% extends "base.html" %} {% block title %}å‚™å¯©æ®µè½ç”Ÿæˆå™¨{% endblock %} {% block
content %}
<div class="generator-container">
  <h2>ğŸ› ï¸ å‚™å¯©æ®µè½ç”Ÿæˆå™¨</h2>

  <div class="form-group">
    <label for="university">é¸æ“‡å­¸æ ¡ï¼š</label>
    <select id="university" class="form-control"></select>
  </div>

  <div class="form-group">
    <label for="department">é¸æ“‡å­¸ç³»ï¼š</label>
    <select id="department" class="form-control"></select>
  </div>

  <button onclick="loadGuidelines()" class="btn btn-primary">ç¢ºèª</button>

  <hr />

  <div class="form-group">
    <label for="section_code">ğŸ“„ æ¬²ç”Ÿæˆæ®µè½</label>
    <select
      id="section_code"
      class="form-control"
      onchange="updateFieldsBasedOnSelection()"
    >
      <option value="" selected>è«‹é¸æ“‡è¦ç”Ÿæˆçš„æ®µè½</option>
      <option value="ABC">èª²ç¨‹å­¸ç¿’æˆæœ</option>
      <option value="N">å¤šå…ƒè¡¨ç¾ç¶œæ•´</option>
      <option value="O">å­¸ç¿’æ­·ç¨‹åæ€</option>
      <option value="P">å­¸ç¿’å‹•æ©Ÿ</option>
      <option value="Q">æœªä¾†è¨ˆç•«</option>
    </select>
  </div>

  <div id="fields"></div>

  <div class="form-group">
    <label for="style">ğŸ“ å ±å‘Šé¢¨æ ¼</label>
    <select id="style" class="form-control">
      <option value="formal">æ­£å¼</option>
      <option value="casual">å£èª</option>
      <option value="concise">ç°¡æ½”</option>
      <option value="detailed">æ·±å…¥åˆ†æ</option>
    </select>
  </div>

  <button onclick="generateParagraph()" class="btn btn-success">ç”Ÿæˆ</button>

  <div id="loading-overlay">
    <div id="loading-spinner">â³ å…§å®¹ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...</div>
  </div>

  <h3>ğŸ“„ ç”Ÿæˆçµæœ</h3>
  <pre id="output" style="white-space: pre-wrap"></pre>
  <button
    id="download-docx"
    style="display: none"
    class="btn btn-secondary"
    onclick="downloadDocx()"
  >
    ğŸ“¥ ä¸‹è¼‰ Word
  </button>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  let schoolData = {};
  let SECTION_MAPPING = {
    ABC: { codes: ["A", "B", "C", "D", "E"] },
    N: { codes: ["F", "G", "H", "I", "J", "K", "L", "M"] },
    O: {
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
    },
    P: {
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
    },
    Q: {
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
    },
  };

  // è¼‰å…¥å­¸æ ¡æ¸…å–®
  function loadUniversities() {
    $.get("/get_universities", function (data) {
      $("#university").empty().append('<option value="">è«‹é¸æ“‡å­¸æ ¡</option>');
      data.forEach((uni) => {
        $("#university").append(`<option value="${uni}">${uni}</option>`);
      });
    });
  }

  function loadDepartments() {
    let university = $("#university").val();
    if (!university) {
      $("#department").empty().append('<option value="">è«‹å…ˆé¸æ“‡å­¸æ ¡</option>');
      return;
    }

    $.get(
      `/get_departments?university=${encodeURIComponent(university)}`,
      function (departments) {
        $("#department").empty().append('<option value="">è«‹é¸æ“‡å­¸ç³»</option>');
        departments.forEach((dept) => {
          $("#department").append(`<option value="${dept}">${dept}</option>`);
        });
      }
    );
  }

  // ç¢ºèªå­¸ç³»å¾Œè¼‰å…¥è©²å­¸ç³»çš„å‚™å¯©è³‡æ–™
  function loadGuidelines() {
    let university = $("#university").val();
    let department = $("#department").val();

    if (!university || !department) {
      alert("è«‹é¸æ“‡å­¸æ ¡èˆ‡å­¸ç³»ï¼");
      return;
    }

    $.ajax({
      url: "/get_guidelines",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({ university, department }),
      dataType: "json",
      success: function (data) {
        if (!data.sections) {
          alert("è©²å­¸ç³»ç›®å‰æ²’æœ‰å‚™å¯©è³‡æ–™ï¼");
          return;
        }

        // å­˜å…¥ sessionStorage æ–¹ä¾¿ `updateFieldsBasedOnSelection()` ä½¿ç”¨
        sessionStorage.setItem(
          `${university}_${department}_sections`,
          JSON.stringify(data.sections)
        );

        // å›ºå®š `section_code` é¸å–®
        $("#section_code").val(""); // é‡ç½®é¸æ“‡
        updateFieldsBasedOnSelection();
      },
      error: function () {
        alert("è¼‰å…¥å‚™å¯©è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥å­¸æ ¡èˆ‡å­¸ç³»æ˜¯å¦æ­£ç¢ºï¼");
      },
    });
  }

  // æ›´æ–°å¯è¼¸å…¥çš„æ¬„ä½
  function updateFieldsBasedOnSelection() {
    let sectionCode = document.getElementById("section_code").value;
    let fieldsDiv = document.getElementById("fields");
    fieldsDiv.innerHTML = ""; // æ¸…ç©ºè¼¸å…¥å€å¡Š

    // ç¢ºä¿ SECTION_MAPPING æœ‰è©² sectionCode
    if (!SECTION_MAPPING.hasOwnProperty(sectionCode)) {
      console.log("ç„¡æ•ˆçš„ section_code:", sectionCode);
      return;
    }

    let requiredCodes = SECTION_MAPPING[sectionCode].codes || [];
    let selectedUniversity = $("#university").val();
    let selectedDepartment = $("#department").val();
    let storedSections = sessionStorage.getItem(
      `${selectedUniversity}_${selectedDepartment}_sections`
    );
    let availableSections = storedSections ? JSON.parse(storedSections) : {};

    // å…ˆæ¸…ç©ºæ¬„ä½
    fieldsDiv.innerHTML = "";

    // å¦‚æœè‡³å°‘æœ‰ä¸€å€‹ç¬¦åˆçš„æ¬„ä½ï¼Œå°±åŠ æ¨™é¡Œ
    let hasValidCodes = requiredCodes.some((code) =>
      availableSections.hasOwnProperty(code)
    );
    if (hasValidCodes) {
      let title = document.createElement("h4");
      title.textContent = "ğŸ“Œè«‹æ–¼ä»¥ä¸‹å„é …ç›®è¼¸å…¥è‡³å¤š300å­—ä¹‹ç°¡è¿°å…§å®¹";
      fieldsDiv.appendChild(title);
    }

    // åªé¡¯ç¤ºå­¸ç³»è¦æ±‚çš„ codes
    requiredCodes.forEach((code) => {
      if (availableSections.hasOwnProperty(code)) {

        let label = document.createElement("label");
        label.innerHTML = `<strong>${code} - ${getCodeName(code)}</strong>`;
        label.style.display = "block";
        fieldsDiv.appendChild(label);

        // é¡¯ç¤ºcontent
        let contentDiv = document.createElement("div");
        contentDiv.innerHTML = `<p>èªªæ˜ï¼š${
          availableSections[code].content || "ï¼ˆç„¡æä¾›åƒè€ƒå…§å®¹ï¼‰"
        }</p>`;
        contentDiv.style.fontSize = "14px";
        contentDiv.style.color = "#666";
        contentDiv.style.marginBottom = "5px";
        fieldsDiv.appendChild(contentDiv);

        // å»ºç«‹ Textarea
        let textarea = document.createElement("textarea");
        textarea.id = `input_${code}`;
        textarea.rows = 5;
        textarea.cols = 50;
        textarea.maxLength = 300;
        textarea.addEventListener("input", () => updateCharCount(textarea));

        // å»ºç«‹å­—æ•¸çµ±è¨ˆ
        let charCount = document.createElement("div");
        charCount.id = `charCount_${code}`;
        charCount.innerHTML = `å‰©é¤˜å­—æ•¸: <span>${textarea.maxLength}</span>`;

        fieldsDiv.appendChild(textarea);
        fieldsDiv.appendChild(charCount);
        fieldsDiv.appendChild(document.createElement("br"));
      }
    });
  }

  function updateCharCount(textarea) {
    let maxLength = textarea.maxLength;
    let currentLength = textarea.value.length;
    let remaining = maxLength - currentLength;

    let charCountDiv = document.getElementById(
      `charCount_${textarea.id.split("_")[1]}`
    );
    if (charCountDiv) {
      charCountDiv.innerHTML = `å‰©é¤˜å­—æ•¸: <span>${remaining}</span>`;
    }
  }

  function getCodeName(code) {
    const CODE_MAPPING = {
      A: "ä¿®èª²ç´€éŒ„",
      B: "æ›¸é¢å ±å‘Š",
      C: "å¯¦ä½œä½œå“",
      D: "è‡ªç„¶ç§‘å­¸æ¢ç©¶",
      E: "ç¤¾æœƒé ˜åŸŸæ¢ç©¶",
      F: "é«˜ä¸­è‡ªä¸»å­¸ç¿’è¨ˆç•«",
      G: "ç¤¾åœ˜æ´»å‹•ç¶“é©—",
      H: "å¹¹éƒ¨ç¶“é©—",
      I: "æœå‹™å­¸ç¿’ç¶“é©—",
      J: "ç«¶è³½è¡¨ç¾",
      K: "éä¿®èª²æˆæœä½œå“",
      L: "æª¢å®šè­‰ç…§",
      M: "ç‰¹æ®Šå„ªè‰¯è¡¨ç¾",
      N: "å¤šå…ƒè¡¨ç¾ç¶œæ•´å¿ƒå¾—",
      O: "é«˜ä¸­å­¸ç¿’æ­·ç¨‹åæ€",
      P: "å­¸ç¿’å‹•æ©Ÿ",
      Q: "æœªä¾†å­¸ç¿’è¨ˆç•«",
    };
    return CODE_MAPPING[code] || "æœªçŸ¥é …ç›®";
  }

  function generateParagraph() {
    let university = $("#university").val();
    let department = $("#department").val();
    let sectionCode = $("#section_code").val();
    let style = $("#style").val();
    let userInputs = {};

    if (!sectionCode) {
      alert("è«‹é¸æ“‡è¦ç”Ÿæˆçš„æ®µè½");
      return;
    }

    console.log("æª¢æŸ¥æ‰€æœ‰ textarea å€¼ï¼š");

    let hasInput = false;
    $("textarea").each(function () {
      let code = this.id.replace("input_", ""); // ç²å– section code
      let value = $(this).val(); // å–å¾—ä½¿ç”¨è€…è¼¸å…¥å€¼

      console.log(`ğŸ”¹${code} => ${value}`); // æª¢æŸ¥æ‰€æœ‰ textarea æ˜¯å¦æœ‰è®€å–åˆ°

      if (value !== undefined && value.trim() !== "") {
        userInputs[code] = value.trim();
        hasInput = true;
      }
    });

    if (!hasInput) {
      alert("è«‹è‡³å°‘å¡«å¯«ä¸€å€‹è¼¸å…¥æ¡†å¾Œå†ç”Ÿæˆæ®µè½ï¼");
      return;
    }

    console.log("é€å‡ºçš„JSONæ•¸æ“š:", {
      university,
      department,
      section_code: sectionCode,
      user_inputs: userInputs,
      style,
    });

    $("#loading-overlay").fadeIn();
    $("#output").empty();
    $("#download-docx").hide();

    $.ajax({
      url: "/generate_paragraph",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        university,
        department,
        section_code: sectionCode,
        user_inputs: userInputs,
        style,
      }),
      dataType: "json",
      success: function (data) {
        $("#loading-overlay").fadeOut();
        $("#output").text(data.generated_text);
        $("#download-docx").show();

        // å­˜å„²ç”Ÿæˆå…§å®¹
        window.generatedDocxData = {
          university,
          department,
          section_code: sectionCode,
          generated_text: data.generated_text,
        };
      },
      error: function (xhr, status, error) {
        $("#loading-overlay").fadeOut();
        console.error("AJAX éŒ¯èª¤:", status, error);
        console.error("ä¼ºæœå™¨å›æ‡‰:", xhr.responseText);
        alert("ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ï¼");
      },
    });
  }

  function downloadDocx() {
    if (!window.generatedDocxData) {
      alert("è«‹å…ˆç”Ÿæˆå…§å®¹ï¼");
      return;
    }

    $.ajax({
      url: "/generate_docx",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(window.generatedDocxData),
      xhrFields: {
        responseType: "blob",
      },
      success: function (blob) {
        let link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);

        let filename = `${window.generatedDocxData.university}${window.generatedDocxData.department}_${window.generatedDocxData.section_code}.docx`;

        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },
      error: function () {
        alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦ï¼");
      },
    });
  }

  // ç¶å®šäº‹ä»¶
  $(document).ready(function () {
    $("#loading-overlay").hide();
    $("#output").empty();
    loadUniversities();

    $("#university").change(loadDepartments);
    $("#department").change(loadGuidelines);
    $("#section_code").change(updateFieldsBasedOnSelection);
    $("#section_code").val("").trigger("change");
  });
</script>

{% endblock %}
