{% extends "base.html" %} {% block title %}å‚™å¯©æ®µè½ç”Ÿæˆå™¨{% endblock %} {% block
content %}

<!-- æ·»åŠ  Mermaid -->
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
<script>
  mermaid.initialize({
    startOnLoad: false,
    theme: 'default',
    securityLevel: 'loose',
    mindmap: {
      padding: 20,
      useMaxWidth: true
    },
    logLevel: 'error'
  });
</script>

<!-- æ·»åŠ  Monaco Editor -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.js"></script>

<!-- Loading Overlay -->
<div id="loading-overlay">
  <div id="loading-spinner">
    <svg class="loading-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
    </svg>
    <svg class="hourglass-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
      <path d="M22 2H2v6h20V2zM22 16H2v6h20v-6zM12 2v20M7 2s2.5 6 5 6 5-6 5-6M7 22s2.5-6 5-6 5 6 5 6"></path>
    </svg>
    <span class="loading-text">è™•ç†ä¸­...</span>
  </div>
</div>

<div id="quota-check-wrapper" style="display: none">
  <div class="generator-container">
    <h2>ğŸ› ï¸ å‚™å¯©æ®µè½ç”Ÿæˆå™¨</h2>

    <div class="form-group">
      <label for="university">é¸æ“‡å­¸æ ¡ï¼š</label>
      <select id="university" class="form-control"></select>
    </div>

    <div class="form-group">
      <label for="department">é¸æ“‡å­¸ç³»ï¼š</label>
      <select id="department" class="form-control"></select>
    </div>

    <button onclick="loadGuidelines()" class="btn btn-primary">ç¢ºèª</button>

    <hr />

    <div class="form-group">
      <label for="section_code">ğŸ“„ æ¬²ç”Ÿæˆæ®µè½</label>
      <select id="section_code" class="form-control" onchange="updateFieldsBasedOnSelection()">
        <option value="" selected>è«‹é¸æ“‡è¦ç”Ÿæˆçš„æ®µè½</option>
        <option value="ABC">èª²ç¨‹å­¸ç¿’æˆæœ</option>
        <option value="N">å¤šå…ƒè¡¨ç¾ç¶œæ•´</option>
        <option value="O">å­¸ç¿’æ­·ç¨‹åæ€</option>
        <option value="P">å­¸ç¿’å‹•æ©Ÿ</option>
        <option value="Q">æœªä¾†è¨ˆç•«</option>
      </select>
    </div>

    <div id="fields"></div>

    <div class="form-group">
      <label for="style">ğŸ“ å ±å‘Šé¢¨æ ¼</label>
      <select id="style" class="form-control">
        <option value="formal">æ­£å¼</option>
        <option value="casual">å£èª</option>
        <option value="concise">ç°¡æ½”</option>
        <option value="detailed">æ·±å…¥åˆ†æ</option>
      </select>
    </div>

    <button onclick="generateParagraph()" class="btn btn-success">ç”Ÿæˆ</button>

    <div class="result-section">
      <h3>ğŸ“„ ç”Ÿæˆçµæœ</h3>
      <div class="result-layout">
        <!-- ä¸Šæ–¹å¿ƒæ™ºåœ–å€åŸŸ -->
        <div class="mindmap-layout">
          <div class="mindmap-editor-panel">
            <h4>âœï¸ ç·¨è¼¯å¿ƒæ™ºåœ–</h4>
            <div id="mindmap-editor"></div>
            <button onclick="updateMindmap()" class="btn btn-primary update-mindmap-btn">æ›´æ–°å¿ƒæ™ºåœ–</button>
          </div>
          <div class="mindmap-preview-panel">
            <h4>ğŸ“Š å¿ƒæ™ºåœ–é è¦½</h4>
            <div id="mindmap-content" class="mindmap-container"></div>
          </div>
        </div>
        <!-- ä¸‹æ–¹ç”Ÿæˆå…§å®¹ -->
        <div id="output" class="output-section"></div>
      </div>
      <button id="download-docx" class="btn btn-secondary" onclick="downloadDocx()">
        ğŸ“¥ ä¸‹è¼‰ Word
      </button>
    </div>

    <!-- åœ¨ç”Ÿæˆçµæœéƒ¨åˆ†æ·»åŠ å¿ƒæ™ºåœ–ç·¨è¼¯å™¨ -->
    <div class="mindmap-editor-container" style="display: none;">
      <h3>ğŸ“ å¿ƒæ™ºåœ–ç·¨è¼¯å™¨</h3>
      <div class="editor-wrapper">
        <div id="mindmap-editor" style="height: 300px; border: 1px solid #ddd;"></div>
        <div class="preview-wrapper">
          <h4>é è¦½</h4>
          <div id="mindmap-preview" class="mindmap-container"></div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="updateMindmap()">æ›´æ–°å¿ƒæ™ºåœ–</button>
    </div>
  </div>
</div>

<style>
.generator-container {
  max-width: 800px;
  margin: 0;
  padding: 20px;
}

.form-group {
  margin-bottom: 20px;
}

.form-control {
  width: 100%;
  padding: 8px 12px;
  border: 1px solid #ddd;
  border-radius: 4px;
  margin-top: 5px;
}

.btn {
  padding: 8px 16px;
  margin: 5px;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary {
  background-color: #007bff;
  color: white;
  border: none;
}

.btn-success {
  background-color: #28a745;
  color: white;
  border: none;
}

.btn-secondary {
  background-color: #6c757d;
  color: white;
  border: none;
}

textarea.form-control {
  min-height: 150px;
  font-size: 16px;
  line-height: 1.6;
  padding: 12px;
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  resize: vertical;
}

.upload-container {
  background-color: #f8f9fa;
  padding: 20px;
  border-radius: 8px;
  margin-top: 15px;
  border: 1px solid #dee2e6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.upload-instructions {
  margin-bottom: 20px;
  padding: 15px;
  background-color: #fff;
  border-radius: 5px;
  border-left: 4px solid #007bff;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}

.input-section {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #dee2e6;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
  margin-bottom: 20px;
}

.char-count {
  color: #666;
  font-size: 14px;
  text-align: right;
  margin-top: 5px;
  padding: 5px;
}

.section-title {
  font-size: 16px;
  font-weight: 500;
  color: #495057;
  margin-bottom: 10px;
}

#loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.9);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  backdrop-filter: blur(5px);
}

#loading-spinner {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255, 255, 255, 0.95);
  padding: 20px 30px;
  border-radius: 20px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  font-size: 16px;
  color: #333;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1001;
  border: 1px solid rgba(0, 0, 0, 0.1);
  min-width: 200px;
  justify-content: center;
  animation: fadeIn 0.3s ease;
}

body.loading {
  overflow: hidden;
}

.loading-icon {
  animation: spin 1s linear infinite;
  width: 24px;
  height: 24px;
}

.hourglass-icon {
  width: 24px;
  height: 24px;
  animation: flip 2s infinite;
}

.loading-text {
  animation: pulse 1.5s ease-in-out infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

@keyframes pulse {
  0% { opacity: 0.6; }
  50% { opacity: 1; }
  100% { opacity: 0.6; }
}

@keyframes fadeIn {
  from { opacity: 0; transform: translate(-50%, -48%); }
  to { opacity: 1; transform: translate(-50%, -50%); }
}

@keyframes flip {
  0% {
    transform: rotate(0deg);
  }
  50% {
    transform: rotate(180deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

.paragraph-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow: hidden;
  transition: all 0.3s ease;
}

.paragraph-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.paragraph-header {
  background: #f8f9fa;
  padding: 15px;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.paragraph-body {
  padding: 20px;
  line-height: 1.6;
}

#output {
  margin-top: 20px;
  padding: 20px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
  .generator-container {
    padding: 10px;
  }
  
  .btn {
    width: 100%;
    margin: 5px 0;
  }
}

/* å¿ƒæ™ºåœ–æ¨£å¼ */
.mindmap-container {
  margin: 20px 0;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  width: 100%;
  overflow: hidden;
  display: flex;  /* æ·»åŠ flexå¸ƒå±€ */
  justify-content: center;  /* æ°´å¹³å±…ä¸­ */
  align-items: center;  /* å‚ç›´å±…ä¸­ */
}

.mindmap-layout {
  display: grid;
  grid-template-columns: minmax(300px, 45%) minmax(400px, 55%);
  gap: 20px;
  width: 100%;
  margin-bottom: 20px;
}

.mindmap-editor-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
}

.mindmap-preview-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
  width: 100%;  /* ä¿®æ”¹å¯¬åº¦ç‚º100% */
  overflow: hidden;  /* æ·»åŠ overflowæ§åˆ¶ */
}

#mindmap-editor {
  height: 400px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 10px;
}

#mindmap-content {
  min-height: 400px;
  width: 100%;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 20px;
  overflow: auto;
  display: flex;
  justify-content: center;
  align-items: center;
  box-sizing: border-box;  /* ç¡®ä¿paddingä¸å½±å“å®½åº¦ */
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 1024px) {
  .mindmap-layout {
    grid-template-columns: 1fr;
  }
  
  #mindmap-editor,
  #mindmap-content {
    height: 300px;
    min-height: 300px;
  }
}

/* æ™ºèƒ½åœ–ç‰‡æ’å…¥æ¨£å¼ */
.suggested-image {
  margin: 15px 0;
  padding: 10px;
  background: #f8f9fa;
  border-radius: 8px;
  text-align: center;
}

.suggested-image img {
  max-width: 100%;
  height: auto;
  border-radius: 4px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.image-caption {
  margin-top: 10px;
  font-size: 14px;
  color: #666;
  font-style: italic;
}

/* å‹•ç•«æ•ˆæœ */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.paragraph-card {
  animation: fadeIn 0.3s ease;
}

/* å¿ƒæ™ºåœ–ç·¨è¼¯å™¨æ¨£å¼ */
.mindmap-editor-container {
  margin: 20px 0;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.editor-wrapper {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
  margin: 20px 0;
}

.preview-wrapper {
  padding: 20px;
  background: #f8f9fa;
  border-radius: 8px;
  min-height: 300px;
}

#mindmap-editor {
  font-family: 'Consolas', monospace;
  font-size: 14px;
}

.preview-wrapper h4 {
  margin-bottom: 15px;
  color: #495057;
}

/* æ·»åŠ å¿ƒæ™ºåœ–ç›¸é—œæ¨£å¼ */
.mindmap-modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.8);
}

.mindmap-modal-content {
  background-color: #fefefe;
  margin: 5% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 90%;
  max-width: 1200px;
  border-radius: 8px;
  position: relative;
}

.mindmap-close {
  position: absolute;
  right: 15px;
  top: 10px;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.mindmap-close:hover {
  color: #666;
}

.mindmap-container {
  overflow: auto;
  max-height: 80vh;
}

.mindmap-container svg {
  cursor: zoom-in;
  transition: transform 0.3s ease;
}

.mindmap-container.zoomed {
  cursor: zoom-out;
}

.mindmap-container.zoomed svg {
  transform: scale(1.5);
  transform-origin: center center;
}

.mindmap-editor-container {
  margin-bottom: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  padding: 20px;
}

.mindmap-toggle-btn {
  background-color: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  margin-bottom: 10px;
}

.mindmap-toggle-btn:hover {
  background-color: #0056b3;
}

/* ä¿®æ”¹ç”Ÿæˆçµæœå€å¡Šæ¨£å¼ */
.paragraph-card {
  background: white;
  border-radius: 10px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow: hidden;
}

.paragraph-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: #f8f9fa;
  border-bottom: 1px solid #dee2e6;
}

.paragraph-tools {
  display: flex;
  gap: 10px;
}

.paragraph-body {
  padding: 20px;
  line-height: 1.6;
}

.result-section {
  margin-top: 30px;
}

/* å¿ƒæ™ºåœ–å®¹å™¨æ¨£å¼ */
.mindmap-container {
  margin: 20px 0;
  padding: 20px;
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  min-height: 200px;
}

.mindmap-container pre.mermaid {
  text-align: center;
  margin: 0;
  min-height: 200px;
}

/* ç¢ºä¿ SVG åœ–è¡¨æ­£ç¢ºé¡¯ç¤º */
.mindmap-container svg {
  width: 100% !important;
  height: auto !important;
  min-height: 200px;
}

/* æ·»åŠ èª¿è©¦ç”¨çš„é‚Šæ¡† */
#mindmap-content {
  border: 1px dashed #ccc;
  min-height: 200px;
  margin: 10px 0;
}

.result-layout {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
}

.mindmap-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
}

.mindmap-editor-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
  width: 90%;
}

.mindmap-preview-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  height: fit-content;
  width: 110%;
}

#mindmap-editor {
  height: 400px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 10px;
}

#mindmap-content {
  min-height: 400px;
  width: 80%;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 20px;
  overflow: auto;
}

.update-mindmap-btn {
  margin-top: 10px;
}

.mindmap-container {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mindmap-container h4 {
  margin: 0;
  padding: 10px 0;
  color: #495057;
}

#mindmap-content {
  min-height: 300px;
  display: flex;
  justify-content: center;
  align-items: center;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 15px;
  width: 80%;
}

#mindmap-content .mermaid {
  width: auto;  /* å…è®¸è‡ªåŠ¨è°ƒæ•´å®½åº¦ */
  height: 400px;
  display: flex;
  justify-content: center;
  align-items: center;
}

#mindmap-content svg {
  max-width: 100%;
  height: auto;
  min-height: 200px;
}

.paragraph-card {
  background: white;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  margin-bottom: 20px;
  overflow: hidden;
}

.paragraph-header {
  background: #f8f9fa;
  padding: 15px;
  border-bottom: 1px solid #dee2e6;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.paragraph-body {
  padding: 20px;
  line-height: 1.6;
}

#download-docx {
  margin-top: 20px;
  align-self: flex-end;
}

/* æç¤ºæ¡†æ¨£å¼ */
.save-toast {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: rgba(0, 0, 0, 0.8);
  color: white;
  padding: 10px 20px;
  border-radius: 4px;
  z-index: 1000;
  animation: fadeInOut 2s ease;
}

.save-toast.error {
  background: rgba(220, 53, 69, 0.9);
}

@keyframes fadeInOut {
  0% { opacity: 0; transform: translateY(20px); }
  10% { opacity: 1; transform: translateY(0); }
  90% { opacity: 1; transform: translateY(0); }
  100% { opacity: 0; transform: translateY(-20px); }
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (min-width: 1024px) {
  .result-layout {
    grid-template-columns: 45% 55%;
  }
  
  .mindmap-panel {
    position: sticky;
    top: 20px;
    height: fit-content;
  }
}

/* ç¢ºä¿å¿ƒæ™ºåœ–ç¯€é»æ–‡å­—å¯ä»¥é¡¯ç¤ºä¸­æ–‡ */
.mindmap-container .mindmap-node text {
  font-family: "Microsoft JhengHei", "å¾®è»Ÿæ­£é»‘é«”", "Arial", sans-serif !important;
  font-size: 14px !important;
}

.mindmap-container .mindmap-node > g > circle,
.mindmap-container .mindmap-node > g > rect {
  fill: #f8f9fa !important;
  stroke: #007bff !important;
  stroke-width: 2px !important;
}

.mindmap-container .mindmap-node.root > g > circle {
  fill: #007bff !important;
}

.mindmap-container .mindmap-node.root > g > text {
  fill: black !important;  /* ä¿®æ”¹ä¸­å¿ƒç¯€é»æ–‡å­—é¡è‰²ç‚ºé»‘è‰² */
  font-weight: bold !important;  /* åŠ ç²—ä¸­å¿ƒç¯€é»æ–‡å­— */
}

.quota-info {
  background: #f8f9fa;
  border-left: 4px solid #007bff;
  padding: 10px 15px;
  margin-bottom: 20px;
  border-radius: 4px;
  font-size: 14px;
}

.quota-info p {
  margin: 0;
  color: #495057;
}

.result-layout {
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
}

.mindmap-panel {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

.mindmap-editor-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.mindmap-preview-panel {
  background: white;
  padding: 20px;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#mindmap-editor {
  height: 300px;
  border: 1px solid #ddd;
  border-radius: 4px;
  width: 100%;
  margin-bottom: 10px;
}

#mindmap-content {
  min-height: 300px;
  width: 100%;
  background: #f8f9fa;
  border-radius: 4px;
  padding: 20px;
  overflow: auto;
}

.update-mindmap-btn {
  width: 100%;
  margin-top: 10px;
}

/* å“åº”å¼å¸ƒå±€ */
@media (min-width: 1200px) {
  .result-layout {
    grid-template-columns: minmax(400px, 45%) 1fr;
  }
  
  .mindmap-panel {
    position: sticky;
    top: 20px;
  }
}

/* ç¡®ä¿å¿ƒæ™ºå›¾å†…å®¹æ­£ç¡®æ˜¾ç¤º */
.mermaid {
  width: 100%;
  height: 100%;
  display: flex;
  justify-content: center;
  align-items: center;
}

.mermaid svg {
  max-width: 100%;
  height: auto !important;
  min-height: 200px;
}

.output-section {
  width: 100%;
  margin-top: 20px;
}

.alert {
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.alert-danger {
  background-color: #fff2f0;
  border: 1px solid #ffccc7;
  color: #cf1322;
}

.alert-danger h5 {
  color: #cf1322;
  margin-top: 0;
  margin-bottom: 10px;
}

.alert-danger small {
  color: #ff7875;
  display: block;
  margin-top: 10px;
}

#mindmap-content .mermaid {
  max-width: 100%;  /* ç¡®ä¿ä¸è¶…å‡ºå®¹å™¨ */
  height: auto;
  display: flex;
  justify-content: center;
  align-items: center;
}
</style>

<!-- æ·»åŠ å¿ƒæ™ºåœ–æ¨¡æ…‹æ¡† -->
<div id="mindmapModal" class="mindmap-modal">
  <div class="mindmap-modal-content">
    <span class="mindmap-close">&times;</span>
    <h3>å¿ƒæ™ºåœ–é è¦½</h3>
    <div id="modalMindmapPreview" class="mindmap-container"></div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
  let schoolData = {};
  let SECTION_MAPPING = {
    ABC: { codes: ["A", "B", "C", "D", "E"] },
    N: { codes: ["F", "G", "H", "I", "J", "K", "L", "M"] },
    O: {
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
    },
    P: {
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
    },
    Q: {
      codes: ["A", "B", "C", "D", "E", "F", "G", "H", "I", "J", "K", "L", "M"],
    },
  };

  // è¼‰å…¥å­¸æ ¡æ¸…å–®
  function loadUniversities() {
    $.get("/get_universities", function (data) {
      $("#university").empty().append('<option value="">è«‹é¸æ“‡å­¸æ ¡</option>');
      data.forEach((uni) => {
        $("#university").append(`<option value="${uni}">${uni}</option>`);
      });
    }).fail(function(xhr, status, error) {
      console.error('è¼‰å…¥å­¸æ ¡æ¸…å–®å¤±æ•—:', error);
      alert("è¼‰å…¥å­¸æ ¡æ¸…å–®å¤±æ•—ï¼Œè«‹é‡è©¦");
    });
  }

  function loadDepartments() {
    return new Promise((resolve, reject) => {
      let university = $("#university").val();
      if (!university) {
        $("#department").empty().append('<option value="">è«‹å…ˆé¸æ“‡å­¸æ ¡</option>');
        resolve();
        return;
      }

      $.get(
        `/get_departments?university=${encodeURIComponent(university)}`,
        function (departments) {
          $("#department").empty().append('<option value="">è«‹é¸æ“‡å­¸ç³»</option>');
          departments.forEach((dept) => {
            $("#department").append(`<option value="${dept}">${dept}</option>`);
          });
          resolve();
        }
      ).fail(reject);
    });
  }

  // ç¢ºèªå­¸ç³»å¾Œè¼‰å…¥è©²å­¸ç³»çš„å‚™å¯©è³‡æ–™
  function loadGuidelines() {
    return new Promise((resolve, reject) => {
      let university = $("#university").val();
      let department = $("#department").val();

      if (!university || !department) {
        alert("è«‹é¸æ“‡å­¸æ ¡èˆ‡å­¸ç³»ï¼");
        reject();
        return;
      }

      $.ajax({
        url: "/get_guidelines",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({ university, department }),
        dataType: "json",
        success: function (data) {
          if (!data.sections) {
            alert("è©²å­¸ç³»ç›®å‰æ²’æœ‰å‚™å¯©è³‡æ–™ï¼");
            reject();
            return;
          }

          // å­˜å…¥ sessionStorage æ–¹ä¾¿ `updateFieldsBasedOnSelection()` ä½¿ç”¨
          sessionStorage.setItem(
            `${university}_${department}_sections`,
            JSON.stringify(data.sections)
          );

          // å›ºå®š `section_code` é¸å–®
          $("#section_code").val(""); // é‡ç½®é¸æ“‡
          updateFieldsBasedOnSelection();
          resolve();
        },
        error: function () {
          alert("è¼‰å…¥å‚™å¯©è³‡æ–™å¤±æ•—ï¼Œè«‹æª¢æŸ¥å­¸æ ¡èˆ‡å­¸ç³»æ˜¯å¦æ­£ç¢ºï¼");
          reject();
        },
      });
    });
  }

  // æ›´æ–°å¯è¼¸å…¥çš„æ¬„ä½
  function updateFieldsBasedOnSelection() {
    let sectionCode = document.getElementById("section_code").value;
    let fieldsDiv = document.getElementById("fields");
    fieldsDiv.innerHTML = ""; // æ¸…ç©ºè¼¸å…¥å€å¡Š

    // ç¢ºä¿ SECTION_MAPPING æœ‰è©² sectionCode
    if (!SECTION_MAPPING.hasOwnProperty(sectionCode)) {
      console.log("ç„¡æ•ˆçš„ section_code:", sectionCode);
      return;
    }

    let requiredCodes = SECTION_MAPPING[sectionCode].codes || [];
    let selectedUniversity = $("#university").val();
    let selectedDepartment = $("#department").val();
    let storedSections = sessionStorage.getItem(
      `${selectedUniversity}_${selectedDepartment}_sections`
    );
    let availableSections = storedSections ? JSON.parse(storedSections) : {};

    // å…ˆæ¸…ç©ºæ¬„ä½
    fieldsDiv.innerHTML = "";

    // å¦‚æœè‡³å°‘æœ‰ä¸€å€‹ç¬¦åˆçš„æ¬„ä½ï¼Œå°±åŠ æ¨™é¡Œ
    let hasValidCodes = requiredCodes.some((code) =>
      availableSections.hasOwnProperty(code)
    );
    if (hasValidCodes) {
      let inputSection = document.createElement("div");
      inputSection.className = "input-section";
      
      let title = document.createElement("h4");
      title.className = "section-title";
      title.textContent = "ğŸ“Œè«‹æ–¼ä»¥ä¸‹å„é …ç›®è¼¸å…¥è‡³å¤š300å­—ä¹‹ç°¡è¿°å…§å®¹";
      inputSection.appendChild(title);
      fieldsDiv.appendChild(inputSection);
    }

    // åªé¡¯ç¤ºå­¸ç³»è¦æ±‚çš„ codes
    requiredCodes.forEach((code) => {
      if (availableSections.hasOwnProperty(code)) {
        let itemSection = document.createElement("div");
        itemSection.className = "input-section";
        
        let label = document.createElement("label");
        label.className = "section-title";
        label.innerHTML = `<strong>${code} - ${getCodeName(code)}</strong>`;
        label.style.display = "block";
        itemSection.appendChild(label);

        // é¡¯ç¤ºcontent
        let contentDiv = document.createElement("div");
        contentDiv.innerHTML = `<p>èªªæ˜ï¼š${
          availableSections[code].content || "ï¼ˆç„¡æä¾›åƒè€ƒå…§å®¹ï¼‰"
        }</p>`;
        contentDiv.style.fontSize = "14px";
        contentDiv.style.color = "#666";
        contentDiv.style.marginBottom = "5px";
        itemSection.appendChild(contentDiv);

        // å»ºç«‹ Textarea
        let textarea = document.createElement("textarea");
        textarea.id = `input_${code}`;
        textarea.rows = 5;
        textarea.cols = 50;
        textarea.maxLength = 300;
        textarea.className = "form-control";
        textarea.placeholder = "åœ¨æ­¤è¼¸å…¥æ–‡å­—æˆ–ä½¿ç”¨ä¸‹æ–¹çš„ä¸Šå‚³åŠŸèƒ½...";
        textarea.addEventListener("input", () => updateCharCount(textarea));

        // å»ºç«‹çµ±ä¸€çš„ä¸Šå‚³å€åŸŸå®¹å™¨
        let uploadContainer = document.createElement("div");
        uploadContainer.className = "upload-container";
        uploadContainer.style.marginBottom = "10px";

        // å»ºç«‹åŠŸèƒ½èªªæ˜å€
        let instructionDiv = document.createElement("div");
        instructionDiv.className = "upload-instructions";
        instructionDiv.innerHTML = `
            <h5>ğŸ“¤ æ–‡ä»¶ä¸Šå‚³å€</h5>
            <div class="upload-section">
                <p class="upload-title">ğŸ¤– æ–‡ä»¶è™•ç†</p>
                <small class="text-muted">
                    â€¢ æ”¯æ´å¤šæª”æ¡ˆä¸Šå‚³ï¼šå¯åŒæ™‚é¸æ“‡å¤šå€‹æª”æ¡ˆ<br>
                    â€¢ æ”¯æ´æ ¼å¼ï¼šåœ–ç‰‡(JPGã€PNG)ã€PDFæª”<br>
                    â€¢ è‡ªå‹•è™•ç†ï¼šOCRæ–‡å­—è¾¨è­˜ + å…§å®¹æ•´ç†<br>
                    â€¢ å­—æ•¸é™åˆ¶ï¼šæ¯å€‹æª”æ¡ˆå…§å®¹å°‡è‡ªå‹•æ“·å–é‡é»
                </small>
            </div>
        `;

        // å»ºç«‹ä¸Šå‚³å€åŸŸ
        let uploadSection = document.createElement("div");
        uploadSection.className = "upload-section";
        
        // å»ºç«‹æ‹–æ”¾å€åŸŸ
        let dropZone = document.createElement("div");
        dropZone.className = "drop-zone";
        dropZone.innerHTML = `
            <div class="drop-zone-content">
                <i class="fas fa-cloud-upload-alt"></i>
                <p>æ‹–æ”¾æª”æ¡ˆåˆ°æ­¤è™•æˆ–é»æ“Šä¸Šå‚³</p>
                <small>æ”¯æ´å¤šå€‹æª”æ¡ˆã€åœ–ç‰‡æˆ–PDF</small>
            </div>
        `;

        // å»ºç«‹æª”æ¡ˆè¼¸å…¥
        let fileInput = document.createElement("input");
        fileInput.type = "file";
        fileInput.id = `files_${code}`;
        fileInput.className = "file-input";
        fileInput.multiple = true;
        fileInput.accept = "image/*,.pdf";
        fileInput.style.display = "none";

        // å»ºç«‹é è¦½å€åŸŸ
        let previewArea = document.createElement("div");
        previewArea.className = "preview-area";
        previewArea.id = `preview_${code}`;

        // å»ºç«‹è™•ç†æŒ‰éˆ•
        let processButton = document.createElement("button");
        processButton.textContent = "ğŸ”„ é–‹å§‹è™•ç†æ–‡ä»¶";
        processButton.className = "btn btn-primary process-btn";
        processButton.style.display = "none";

        // æ·»åŠ æ‹–æ”¾äº‹ä»¶è™•ç†
        dropZone.addEventListener('click', () => fileInput.click());
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            handleFiles(Array.from(e.dataTransfer.files), code);
        });

        // æª”æ¡ˆé¸æ“‡è™•ç†
        fileInput.addEventListener('change', (e) => {
            handleFiles(Array.from(e.target.files), code);
        });

        // è™•ç†æŒ‰éˆ•é»æ“Šäº‹ä»¶
        processButton.addEventListener('click', () => {
            processFiles(code);
        });

        // å°‡å…ƒç´ æ·»åŠ åˆ°å®¹å™¨ä¸­
        uploadSection.appendChild(dropZone);
        uploadSection.appendChild(fileInput);
        uploadSection.appendChild(previewArea);
        uploadSection.appendChild(processButton);

        uploadContainer.appendChild(instructionDiv);
        uploadContainer.appendChild(uploadSection);

        // å»ºç«‹å­—æ•¸çµ±è¨ˆ
        let charCount = document.createElement("div");
        charCount.id = `charCount_${code}`;
        charCount.className = "char-count";
        charCount.innerHTML = `å‰©é¤˜å­—æ•¸: <span>${textarea.maxLength}</span>`;

        itemSection.appendChild(textarea);
        itemSection.appendChild(uploadContainer);
        itemSection.appendChild(charCount);
        fieldsDiv.appendChild(itemSection);

        // æ·»åŠ æ¨£å¼
        let style = document.createElement('style');
        style.textContent = `
            .upload-container {
                background-color: #f8f9fa;
                padding: 20px;
                border-radius: 8px;
                margin-top: 15px;
            }
            .upload-instructions {
                margin-bottom: 20px;
                padding: 15px;
                background-color: #fff;
                border-radius: 5px;
                border-left: 4px solid #007bff;
            }
            .drop-zone {
                border: 2px dashed #007bff;
                border-radius: 8px;
                padding: 30px;
                text-align: center;
                cursor: pointer;
                transition: all 0.3s ease;
            }
            .drop-zone:hover, .drop-zone.drag-over {
                background-color: #e3f2fd;
                border-color: #0056b3;
            }
            .drop-zone-content {
                color: #007bff;
            }
            .drop-zone-content i {
                font-size: 48px;
                margin-bottom: 10px;
            }
            .preview-area {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 15px;
            }
            .preview-item {
                position: relative;
                width: 100px;
                height: 100px;
                border-radius: 4px;
                overflow: hidden;
            }
            .preview-item img {
                width: 100%;
                height: 100%;
                object-fit: cover;
            }
            .preview-item .remove-btn {
                position: absolute;
                top: 5px;
                right: 5px;
                background: rgba(255,255,255,0.8);
                border: none;
                border-radius: 50%;
                width: 20px;
                height: 20px;
                font-size: 12px;
                cursor: pointer;
            }
            .process-btn {
                margin-top: 15px;
                width: 100%;
            }
        `;
        document.head.appendChild(style);

        // æ·»åŠ  Font Awesome
        if (!document.querySelector('link[href*="font-awesome"]')) {
            let fontAwesome = document.createElement('link');
            fontAwesome.rel = 'stylesheet';
            fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
            document.head.appendChild(fontAwesome);
        }
      }
    });
  }

  function updateCharCount(textarea) {
    let maxLength = textarea.maxLength;
    let currentLength = textarea.value.length;
    let remaining = maxLength - currentLength;

    let charCountDiv = document.getElementById(
      `charCount_${textarea.id.split("_")[1]}`
    );
    if (charCountDiv) {
      charCountDiv.innerHTML = `å‰©é¤˜å­—æ•¸: <span>${remaining}</span>`;
    }
  }

  function getCodeName(code) {
    const CODE_MAPPING = {
      A: "ä¿®èª²ç´€éŒ„",
      B: "æ›¸é¢å ±å‘Š",
      C: "å¯¦ä½œä½œå“",
      D: "è‡ªç„¶ç§‘å­¸æ¢ç©¶",
      E: "ç¤¾æœƒé ˜åŸŸæ¢ç©¶",
      F: "é«˜ä¸­è‡ªä¸»å­¸ç¿’è¨ˆç•«",
      G: "ç¤¾åœ˜æ´»å‹•ç¶“é©—",
      H: "å¹¹éƒ¨ç¶“é©—",
      I: "æœå‹™å­¸ç¿’ç¶“é©—",
      J: "ç«¶è³½è¡¨ç¾",
      K: "éä¿®èª²æˆæœä½œå“",
      L: "æª¢å®šè­‰ç…§",
      M: "ç‰¹æ®Šå„ªè‰¯è¡¨ç¾",
      N: "å¤šå…ƒè¡¨ç¾ç¶œæ•´å¿ƒå¾—",
      O: "é«˜ä¸­å­¸ç¿’æ­·ç¨‹åæ€",
      P: "å­¸ç¿’å‹•æ©Ÿ",
      Q: "æœªä¾†å­¸ç¿’è¨ˆç•«",
    };
    return CODE_MAPPING[code] || "æœªçŸ¥é …ç›®";
  }

  // é¡¯ç¤º loading
  function showLoading(message = "è™•ç†ä¸­...") {
    $("body").addClass("loading");
    const useHourglass = message.includes("è™•ç†æ–‡ä»¶") || message.includes("ç”Ÿæˆå…§å®¹");
    $("#loading-spinner").html(`
      ${useHourglass ? `
      <svg class="hourglass-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2H2v6h20V2zM22 16H2v6h20v-6zM12 2v20M7 2s2.5 6 5 6 5-6 5-6M7 22s2.5-6 5-6 5 6 5 6"></path>
      </svg>
      ` : `
      <svg class="loading-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"></path>
      </svg>
      `}
      <span class="loading-text">${message}</span>
    `);
    $("#loading-overlay").css('display', 'flex').fadeIn(300);
  }

  // éš±è— loading
  function hideLoading() {
    $("#loading-overlay").fadeOut(300, function() {
      $("body").removeClass("loading");
    });
  }

  // ä¿®æ”¹æ¸²æŸ“å¿ƒæ™ºåœ–çš„å‡½æ•¸
  function renderMindmap(code) {
    console.log('é–‹å§‹æ¸²æŸ“å¿ƒæ™ºåœ–ï¼Œä»£ç¢¼é•·åº¦:', code.length);
    
    if (!code || typeof code !== 'string') {
      console.error('ç„¡æ•ˆçš„å¿ƒæ™ºåœ–ä»£ç¢¼');
      return;
    }

    // åˆå§‹åŒ–ç·¨è¼¯å™¨ï¼ˆå¦‚æœé‚„æ²’æœ‰åˆå§‹åŒ–ï¼‰
    if (!window.mindmapEditor) {
      require(['vs/editor/editor.main'], function() {
        window.mindmapEditor = monaco.editor.create(document.getElementById('mindmap-editor'), {
          value: code,
          language: 'markdown',
          theme: 'vs-light',
          minimap: { enabled: false },
          lineNumbers: 'on',
          scrollBeyondLastLine: false,
          automaticLayout: true,
          fontSize: 14
        });

        // æ·»åŠ å¯¦æ™‚é è¦½
        let previewTimeout;
        window.mindmapEditor.onDidChangeModelContent(() => {
          clearTimeout(previewTimeout);
          previewTimeout = setTimeout(() => {
            const newCode = window.mindmapEditor.getValue();
            updateMindmapPreview(newCode);
          }, 300);
        });
      });
    } else {
      window.mindmapEditor.setValue(code);
    }

    // æ›´æ–°é è¦½
    updateMindmapPreview(code);
  }

  function updateMindmapPreview(code) {
    const container = document.getElementById('mindmap-content');
    if (!container) {
      console.error('æ‰¾ä¸åˆ° mindmap-content å®¹å™¨');
      return;
    }

    // ç¢ºä¿ä»£ç¢¼ä»¥ "mindmap" é–‹é ­
    let processedCode = code.trim();
    if (!processedCode.startsWith('mindmap')) {
      processedCode = 'mindmap\n' + processedCode;
    }

    // æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';
    
    // å‰µå»ºæ–°çš„ mermaid å…ƒç´ 
    const mermaidDiv = document.createElement('div');
    mermaidDiv.className = 'mermaid';
    mermaidDiv.textContent = processedCode;
    container.appendChild(mermaidDiv);

    // é‡æ–°åˆå§‹åŒ– mermaid
    try {
      mermaid.initialize({
        startOnLoad: false,
        theme: 'default',
        securityLevel: 'loose',
        mindmap: {
          padding: 20,
          useMaxWidth: true
        }
      });

      // ä½¿ç”¨ Promise è™•ç†æ¸²æŸ“
      mermaid.init(undefined, '.mermaid')
        .then(() => {
          console.log('å¿ƒæ™ºåœ–é è¦½æ›´æ–°æˆåŠŸ');
          const svg = container.querySelector('svg');
          if (svg) {
            svg.style.width = '100%';
            svg.style.height = 'auto';
            svg.style.minHeight = '200px';
          }
        })
        .catch(err => {
          console.error('å¿ƒæ™ºåœ–é è¦½æ›´æ–°å¤±æ•—:', err);
          container.innerHTML = '<div class="error-message">å¿ƒæ™ºåœ–é è¦½ç”Ÿæˆå¤±æ•—ï¼Œè«‹æª¢æŸ¥èªæ³•æ˜¯å¦æ­£ç¢º</div>';
        });
    } catch (err) {
      console.error('Mermaid åˆå§‹åŒ–å¤±æ•—:', err);
      container.innerHTML = '<div class="error-message">å¿ƒæ™ºåœ–é è¦½åˆå§‹åŒ–å¤±æ•—</div>';
    }
  }

  function updateMindmap() {
    const newCode = window.mindmapEditor.getValue();
    
    // æ›´æ–°é è¦½
    updateMindmapPreview(newCode);
    
    // æ›´æ–°å…¨å±€æ•¸æ“šä¸­çš„å¿ƒæ™ºåœ–
    if (window.generatedDocxData) {
      window.generatedDocxData.mindmap_data = {
        mindmap_svg: newCode
      };
      // é‡æ–°å•Ÿç”¨ä¿å­˜åŠŸèƒ½
      saveGeneratedContent(window.generatedDocxData);
    }
  }

  // ä¿å­˜ç”Ÿæˆçš„å…§å®¹
  function saveGeneratedContent(data) {
    if (!data) {
      console.error('ç„¡æ•ˆçš„ç”Ÿæˆæ•¸æ“š');
      return;
    }

    // æª¢æŸ¥å¿…è¦æ¬„ä½
    if (!data.university || !data.department || !data.section_code || !data.generated_text) {
      console.error('ç¼ºå°‘å¿…è¦æ¬„ä½');
      return;
    }

    // æ§‹å»ºè«‹æ±‚æ•¸æ“š
    const requestData = {
      university: data.university,
      department: data.department,
      section_code: data.section_code,
      generated_text: data.generated_text,
      mindmap_data: data.mindmap_data || null,
      style: data.style || 'formal'
    };

    console.log('æ­£åœ¨ä¿å­˜ç”Ÿæˆå…§å®¹:', requestData);

    $.ajax({
      url: "/save_generated_content",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(requestData),
      success: function(response) {
        if (response.success) {
          console.log("å…§å®¹å·²ä¿å­˜ï¼Œhistory_id:", response.history_id);
          
          // æ›´æ–°URLï¼Œä½†ä¸é‡æ–°åŠ è¼‰é é¢
          if (response.history_id) {
            const newUrl = new URL(window.location.href);
            newUrl.searchParams.set('history_id', response.history_id);
            window.history.pushState({}, '', newUrl);

            // é¡¯ç¤ºæˆåŠŸæç¤º
            showSuccessToast('âœ… æ›´æ”¹å·²ä¿å­˜');
          }
        } else {
          console.error("ä¿å­˜å¤±æ•—:", response.error);
          showErrorToast(response.error || "ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
        }
      },
      error: function(xhr, status, error) {
        console.error("ä¿å­˜å¤±æ•—:", error);
        console.error("è©³ç´°éŒ¯èª¤:", xhr.responseText);
        showErrorToast("ä¿å­˜å¤±æ•—ï¼Œè«‹é‡è©¦");
      }
    });
  }

  function showSuccessToast(message) {
    const toast = document.createElement('div');
    toast.className = 'save-toast';
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 2000);
  }

  function showErrorToast(message) {
    const toast = document.createElement('div');
    toast.className = 'save-toast error';
    toast.textContent = `âŒ ${message}`;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.remove();
    }, 2000);
  }

  // ä¿®æ”¹ç”Ÿæˆæ®µè½çš„å‡½æ•¸
  function generateParagraph() {
    let university = $("#university").val();
    let department = $("#department").val();
    let sectionCode = $("#section_code").val();
    let style = $("#style").val();
    let userInputs = {};

    if (!sectionCode) {
      alert("è«‹é¸æ“‡è¦ç”Ÿæˆçš„æ®µè½");
      return;
    }

    let hasInput = false;
    $("textarea").each(function () {
      let code = this.id.replace("input_", "");
      let value = $(this).val();
      if (value !== undefined && value.trim() !== "") {
        userInputs[code] = value.trim();
        hasInput = true;
      }
    });

    if (!hasInput) {
      alert("è«‹è‡³å°‘å¡«å¯«ä¸€å€‹è¼¸å…¥æ¡†å¾Œå†ç”Ÿæˆæ®µè½ï¼");
      return;
    }

    // æ¸…ç©ºä¹‹å‰çš„ç”Ÿæˆçµæœ
    $("#output").empty();
    
    showLoading("ğŸ¤– æ­£åœ¨ç”Ÿæˆå…§å®¹ï¼Œè«‹ç¨å€™...");

    // å…ˆç”Ÿæˆå¿ƒæ™ºåœ–
    $.ajax({
      url: "/generate_mindmap",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        university,
        department,
        section_code: sectionCode,
        user_inputs: userInputs
      }),
      success: function(mindmapData) {
        console.log("å¿ƒæ™ºåœ–ç”ŸæˆæˆåŠŸ:", mindmapData);
        
        // æª¢æŸ¥ä¸¦æå–å¿ƒæ™ºåœ–ä»£ç¢¼
        let mindmapCode = null;
        if (typeof mindmapData === 'object') {
          if (mindmapData.mindmap_svg) {
            mindmapCode = mindmapData.mindmap_svg;
          } else if (mindmapData.mindmap_code) {
            mindmapCode = mindmapData.mindmap_code;
          }
        }

        // å¦‚æœæ‰¾åˆ°æœ‰æ•ˆçš„å¿ƒæ™ºåœ–ä»£ç¢¼ï¼Œé€²è¡Œæ¸²æŸ“
        if (mindmapCode && typeof mindmapCode === 'string') {
          console.log("é–‹å§‹æ¸²æŸ“å¿ƒæ™ºåœ–");
          renderMindmap(mindmapCode.trim());
        } else {
          console.error("ç„¡æ•ˆçš„å¿ƒæ™ºåœ–æ•¸æ“šæ ¼å¼");
        }
        
        // ç¹¼çºŒç”Ÿæˆæ®µè½
        generateParagraphContent(mindmapData);
      },
      error: function(xhr, status, error) {
        console.error("ç”Ÿæˆå¿ƒæ™ºåœ–éŒ¯èª¤:", error);
        hideLoading();
        alert("ç”Ÿæˆå¿ƒæ™ºåœ–æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦");
      }
    });
  }

  // ä¿®æ”¹æ®µè½ç”Ÿæˆå‡½æ•¸
  function generateParagraphContent(mindmapData) {
    console.log("é–‹å§‹ç”Ÿæˆæ®µè½å…§å®¹");
    let university = $("#university").val();
    let department = $("#department").val();
    let sectionCode = $("#section_code").val();
    let style = $("#style").val();
    let userInputs = {};

    $("textarea").each(function () {
      let code = this.id.replace("input_", "");
      let value = $(this).val();
      if (value !== undefined && value.trim() !== "") {
        userInputs[code] = value.trim();
      }
    });

    // æ§‹å»ºè«‹æ±‚æ•¸æ“š
    const requestData = {
      university,
      department,
      section_code: sectionCode,
      user_inputs: userInputs,
      style,
      mindmap_data: mindmapData
    };

    console.log("ç™¼é€ç”Ÿæˆæ®µè½è«‹æ±‚:", requestData);

    $.ajax({
      url: "/generate_paragraph",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(requestData),
      success: function(data) {
        console.log("æ®µè½ç”ŸæˆæˆåŠŸ:", data);
        hideLoading();

        if (!data || !data.generated_text) {
          console.error("ç”Ÿæˆçš„æ•¸æ“šæ ¼å¼ç„¡æ•ˆ");
          alert("ç”Ÿæˆçš„å…§å®¹æ ¼å¼ç„¡æ•ˆï¼Œè«‹é‡è©¦");
          return;
        }

        // é¡¯ç¤ºç”Ÿæˆçš„æ®µè½
        const blocks = data.generated_text.split(/\n{2,}/);
        blocks.forEach((block, idx) => {
          const trimmed = block.trim();
          if (!trimmed) return;

          const isTable = trimmed.includes("<table");
          let contentHtml = isTable
            ? trimmed
            : `<p>${trimmed.replace(/\n/g, "<br>")}</p>`;

          $("#output").append(`
            <div class="paragraph-card" id="paragraph-${idx}">
              <div class="paragraph-header">
                <span>ğŸ“„ æ®µè½ ${idx + 1}</span>
                ${!isTable ? 
                  `<button class="btn btn-outline-primary btn-sm" onclick="regenerateParagraph(${idx})">
                    ğŸ”„ é‡æ–°ç”Ÿæˆ
                  </button>` : 
                  ''}
              </div>
              <div class="paragraph-body">
                ${contentHtml}
              </div>
            </div>
          `);
        });

        // ä¿å­˜ç”Ÿæˆçµæœåˆ°å…¨å±€è®Šé‡
        window.generatedDocxData = {
          university,
          department,
          section_code: sectionCode,
          generated_text: data.generated_text,
          mindmap_data: mindmapData,
          style: style
        };

        // ä¿å­˜åˆ°æ­·å²è¨˜éŒ„
        saveGeneratedContent(window.generatedDocxData);

        $("#download-docx").show();
      },
      error: function(xhr, status, error) {
        hideLoading();
        console.error("ç”Ÿæˆæ®µè½éŒ¯èª¤:", error);
        console.error("HTTP ç‹€æ…‹:", xhr.status);
        console.error("éŒ¯èª¤è©³æƒ…:", xhr.responseText);

        let errorMessage = "ç”Ÿæˆæ®µè½æ™‚ç™¼ç”ŸéŒ¯èª¤";
        
        try {
          // å˜—è©¦è§£æéŒ¯èª¤éŸ¿æ‡‰
          const errorResponse = JSON.parse(xhr.responseText);
          if (errorResponse.error) {
            errorMessage = errorResponse.error;
          }
        } catch (e) {
          // å¦‚æœç„¡æ³•è§£æ JSONï¼Œä½¿ç”¨åŸå§‹éŒ¯èª¤æ–‡æœ¬
          if (xhr.responseText) {
            errorMessage = xhr.responseText;
          }
        }

        // é¡¯ç¤ºéŒ¯èª¤æç¤º
        const errorHtml = `
          <div class="alert alert-danger">
            <h5>âŒ ç”Ÿæˆå¤±æ•—</h5>
            <p>${errorMessage}</p>
            <small>è«‹ç¨å¾Œé‡è©¦æˆ–è¯ç¹«ç®¡ç†å“¡</small>
          </div>
        `;
        
        $("#output").html(errorHtml);
      }
    });
  }

  function regenerateParagraph(index) {
    const paraCard = document.querySelector(
      `#paragraph-${index} .paragraph-body`
    );
    const style = $("#style").val() || "formal";
    const title = paraCard.querySelector("h4")?.innerText || "";
    const body = paraCard.querySelector("p")?.innerText || "";

    // æš«æ™‚é¡¯ç¤º loading spinner
    paraCard.innerHTML = `
    <div style="text-align:center; padding:20px;">
      â³ æ®µè½é‡æ–°ç”Ÿæˆä¸­...
    </div>
  `;

    $.ajax({
      url: "/regenerate_paragraph",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify({
        original_paragraph: `${title}\n${body}`,
        style: style,
      }),
      success: function (data) {
        const [newTitle, ...newRest] = data.new_paragraph.trim().split("\n");
        const newBody = newRest.join("\n");
        paraCard.innerHTML = `
        <h4>${newTitle}</h4>
        <p>${newBody}</p>
      `;
      },
      error: function (xhr, status, error) {
        paraCard.innerHTML = `<p style="color:red;">âŒ ç”Ÿæˆå¤±æ•—ï¼Œè«‹é‡è©¦</p>`;
      },
    });
  }

  function downloadDocx() {
    if (!window.generatedDocxData) {
      alert("è«‹å…ˆç”Ÿæˆå…§å®¹ï¼");
      return;
    }

    $.ajax({
      url: "/generate_docx",
      type: "POST",
      contentType: "application/json",
      data: JSON.stringify(window.generatedDocxData),
      xhrFields: {
        responseType: "blob",
      },
      success: function (blob) {
        let link = document.createElement("a");
        link.href = window.URL.createObjectURL(blob);

        let filename = `${window.generatedDocxData.university}${window.generatedDocxData.department}_${window.generatedDocxData.section_code}.docx`;

        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      },
      error: function () {
        alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹é‡è©¦ï¼");
      },
    });
  }

  // è™•ç†å¤šæ–‡ä»¶ä¸Šå‚³
  function handleFiles(files, code) {
    const previewArea = document.getElementById(`preview_${code}`);
    const processButton = previewArea.nextElementSibling;
    
    // æ¸…ç©ºé è¦½å€
    if (!previewArea.hasChildNodes()) {
        previewArea.innerHTML = '';
    }

    // è™•ç†æ¯å€‹æ–‡ä»¶
    files.forEach(file => {
        const reader = new FileReader();
        const previewItem = document.createElement('div');
        previewItem.className = 'preview-item';
        
        // å‰µå»ºåˆªé™¤æŒ‰éˆ•
        const removeBtn = document.createElement('button');
        removeBtn.className = 'remove-btn';
        removeBtn.innerHTML = 'Ã—';
        removeBtn.onclick = () => {
            previewItem.remove();
            if (!previewArea.hasChildNodes()) {
                processButton.style.display = 'none';
            }
        };

        if (file.type.startsWith('image/')) {
            reader.onload = (e) => {
                previewItem.innerHTML = `
                    <img src="${e.target.result}" alt="preview">
                `;
                previewItem.appendChild(removeBtn);
            };
            reader.readAsDataURL(file);
        } else if (file.type === 'application/pdf') {
            previewItem.innerHTML = `
                <div style="background: #f8f9fa; height: 100%; display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-file-pdf" style="font-size: 40px; color: #dc3545;"></i>
                </div>
            `;
            previewItem.appendChild(removeBtn);
        }

        previewArea.appendChild(previewItem);
    });

    // é¡¯ç¤ºè™•ç†æŒ‰éˆ•
    processButton.style.display = 'block';
  }

  // è™•ç†å¤šå€‹æ–‡ä»¶
  async function processFiles(code) {
    const fileInput = document.getElementById(`files_${code}`);
    const textarea = document.getElementById(`input_${code}`);
    
    if (!fileInput.files || fileInput.files.length === 0) {
        alert("è«‹å…ˆé¸æ“‡è¦è™•ç†çš„æª”æ¡ˆï¼");
        return;
    }

    // é¡¯ç¤ºè¼‰å…¥ä¸­
    $("#loading-overlay").fadeIn();
    $("#loading-spinner").html(`
      <svg class="hourglass-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M22 2H2v6h20V2zM22 16H2v6h20v-6zM12 2v20M7 2s2.5 6 5 6 5-6 5-6M7 22s2.5-6 5-6 5 6 5 6"></path>
      </svg>
      <span class="loading-text">â³ æ­£åœ¨è™•ç†æ–‡ä»¶...</span>
    `);

    try {
        let allText = '';
        const MAX_TOTAL_LENGTH = 300;

        for (let file of fileInput.files) {
            let singleFormData = new FormData();
            singleFormData.append('file', file);
            singleFormData.append('code', code);

            const response = await fetch('/process_ocr', {
                method: 'POST',
                body: singleFormData
            });

            const result = await response.json();
            if (result.success) {
                let processedText = `ã€${file.name}ã€‘\n${result.text}\n\n`;
                
                // å¦‚æœå…§å®¹è¢«æ¿ƒç¸®äº†ï¼Œæ·»åŠ æç¤º
                if (result.was_condensed) {
                    processedText = `ã€${file.name}ã€‘(å·²è‡ªå‹•æ¿ƒç¸®)\n${result.text}\n\n`;
                }
                
                // æª¢æŸ¥ç¸½å­—æ•¸
                if ((allText.length + processedText.length) > MAX_TOTAL_LENGTH) {
                    // å¦‚æœå·²ç¶“æœ‰å…§å®¹ï¼Œé€²è¡Œæ•´é«”æ¿ƒç¸®
                    if (allText) {
                        const response = await fetch('/condense_text', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                text: allText + processedText,
                                max_length: MAX_TOTAL_LENGTH
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            allText = result.text + "\n\n(å…§å®¹å·²è‡ªå‹•æ¿ƒç¸®è‡³300å­—)";
                        }
                    }
                    break;
                }
                
                allText += processedText;
            }
        }

        if (allText) {
            textarea.value = allText.trim();
            updateCharCount(textarea);
        } else {
            alert("ç„¡æ³•è™•ç†æ–‡ä»¶ï¼Œè«‹é‡è©¦");
        }
    } catch (error) {
        console.error('è™•ç†æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
        alert("è™•ç†æ–‡ä»¶æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦");
    } finally {
        $("#loading-overlay").fadeOut();
        $("#loading-spinner").text("â³ å…§å®¹ç”Ÿæˆä¸­ï¼Œè«‹ç¨å€™...");
    }
  }

  // ç¶å®šäº‹ä»¶
  $(document).ready(function () {
    // æª¢æŸ¥æ˜¯å¦å·²ç™»å…¥
    $.get("/check_auth", function(data) {
      if (!data.authenticated) {
        if (confirm("éœ€è¦å…ˆè¨»å†Šæˆç‚ºæœƒå“¡æ‰èƒ½ä½¿ç”¨æ­¤åŠŸèƒ½ã€‚\næ˜¯å¦å‰å¾€è¨»å†Šé é¢ï¼Ÿ")) {
          window.location.href = "/register";
        } else {
          window.location.href = "/";
        }
        return;
      }
      
      // å…ˆå…¨éƒ¨éš±è—
      $("#quota-check-wrapper").hide();
      $("#output").empty();

      // ğŸ›¡ï¸ å…ˆæª¢æŸ¥é…é¡
      $.get("/check_quota", function (data) {
        if (data.is_expired) {
          alert("â— ä½ çš„æœƒå“¡æ–¹æ¡ˆå·²éæœŸï¼Œè«‹çºŒç´„ä»¥ç¹¼çºŒä½¿ç”¨ï¼");
          window.location.href = "/purchase";
          return;
        }
        
        if (data.remaining_quota <= 0 && data.plan !== "Unlimited") {
          alert("â— ä½ çš„ç”Ÿæˆæ¬¡æ•¸å·²ç”¨å®Œï¼Œè«‹å‡ç´šæœƒå“¡ä»¥ç¹¼çºŒä½¿ç”¨ï¼");
          window.location.href = "/purchase";
          return;
        }
        
        // é€šéæª¢æŸ¥ï¼Œé¡¯ç¤ºå‰©é¤˜æ¬¡æ•¸æç¤ºï¼ˆå¦‚æœä¸æ˜¯ç„¡é™æ–¹æ¡ˆï¼‰
        if (data.plan !== "Unlimited") {
          const quotaInfo = document.createElement('div');
          quotaInfo.className = 'quota-info';
          quotaInfo.innerHTML = `
            <p>ğŸ“Š æœ¬æœˆå·²ä½¿ç”¨ ${data.used_quota}/${data.total_quota} æ¬¡
               ${data.expiration_date ? `ï¼ˆåˆ°æœŸæ—¥ï¼š${data.expiration_date}ï¼‰` : ''}</p>
          `;
          document.querySelector('.generator-container').insertBefore(
            quotaInfo, 
            document.querySelector('.form-group')
          );
        }
        
        // é¡¯ç¤ºé é¢å…§å®¹
        $("#quota-check-wrapper").fadeIn();
        loadUniversities();
        $("#university").change(loadDepartments);
        $("#department").change(loadGuidelines);
        $("#section_code").change(updateFieldsBasedOnSelection);
        $("#section_code").val("").trigger("change");
      }).fail(function () {
        alert("âŒ ç„¡æ³•ç¢ºèªä½¿ç”¨æ¬¡æ•¸ï¼Œè«‹ç¨å¾Œå†è©¦ï¼");
      });

      // æª¢æŸ¥ URL åƒæ•¸æ˜¯å¦æœ‰æ­·å²è¨˜éŒ„ ID
      const urlParams = new URLSearchParams(window.location.search);
      const historyId = urlParams.get('history_id');
      
      if (historyId) {
          loadHistoryContent(historyId);
      }
    });
  });

  // ä¿®æ”¹è¼‰å…¥æ­·å²è¨˜éŒ„çš„å‡½æ•¸
  async function loadHistoryContent(historyId) {
    try {
      showLoading("è¼‰å…¥æ­·å²è¨˜éŒ„ä¸­...");
      
      // 1. å…ˆè¼‰å…¥æ­·å²è¨˜éŒ„æ•¸æ“š
      const historyResponse = await $.get(`/load_history?history_id=${historyId}`);
      
      if (!historyResponse || !historyResponse.university || !historyResponse.department) {
        throw new Error('æ­·å²è¨˜éŒ„æ•¸æ“šä¸å®Œæ•´');
      }

      // 2. è¼‰å…¥å­¸æ ¡åˆ—è¡¨ä¸¦é¸æ“‡å°æ‡‰å­¸æ ¡
      const universities = await $.get("/get_universities");
      $("#university").empty().append('<option value="">è«‹é¸æ“‡å­¸æ ¡</option>');
      universities.forEach((uni) => {
        $("#university").append(`<option value="${uni}">${uni}</option>`);
      });
      $("#university").val(historyResponse.university);

      // 3. è¼‰å…¥è©²å­¸æ ¡çš„ç§‘ç³»åˆ—è¡¨ä¸¦é¸æ“‡å°æ‡‰ç§‘ç³»
      const departments = await $.get(`/get_departments?university=${encodeURIComponent(historyResponse.university)}`);
      $("#department").empty().append('<option value="">è«‹é¸æ“‡å­¸ç³»</option>');
      departments.forEach((dept) => {
        $("#department").append(`<option value="${dept}">${dept}</option>`);
      });
      $("#department").val(historyResponse.department);

      // 4. è¼‰å…¥å‚™å¯©æŒ‡å¼•
      const guidelinesResponse = await $.ajax({
        url: "/get_guidelines",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify({
          university: historyResponse.university,
          department: historyResponse.department
        })
      });

      if (!guidelinesResponse.sections) {
        throw new Error('ç„¡æ³•è¼‰å…¥å‚™å¯©æŒ‡å¼•');
      }

      // 5. å„²å­˜å‚™å¯©æŒ‡å¼•åˆ° sessionStorage
      sessionStorage.setItem(
        `${historyResponse.university}_${historyResponse.department}_sections`,
        JSON.stringify(guidelinesResponse.sections)
      );

      // 6. è¨­ç½®æ®µè½ä»£ç¢¼å’Œé¢¨æ ¼
      $("#section_code").val(historyResponse.section_code);
      $("#style").val(historyResponse.style || 'formal');
      
      // 7. æ›´æ–°è¼¸å…¥æ¬„ä½
      updateFieldsBasedOnSelection();
      
      // 8. ç­‰å¾…è¼¸å…¥æ¬„ä½ç”Ÿæˆå®Œæˆ
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // 9. å¡«å…¥ä½¿ç”¨è€…è¼¸å…¥ï¼ˆå¦‚æœæœ‰ï¼‰
      try {
        if (historyResponse.user_inputs && Object.keys(historyResponse.user_inputs).length > 0) {
          Object.entries(historyResponse.user_inputs).forEach(([code, value]) => {
            const inputField = document.getElementById(`input_${code}`);
            if (inputField) {
              inputField.value = value;
              updateCharCount(inputField);
            }
          });
        }
      } catch (error) {
        console.warn('ç„¡æ³•è¼‰å…¥ä½¿ç”¨è€…è¼¸å…¥:', error);
      }
      
      // 10. é¡¯ç¤ºç”Ÿæˆçµæœ
      if (historyResponse.generated_text) {
        displayHistoryContent(historyResponse);
      }
      
      // 11. å¦‚æœæœ‰å¿ƒæ™ºåœ–æ•¸æ“šï¼Œè¼‰å…¥ä¸¦æ¸²æŸ“
      if (historyResponse.mindmap_data) {
        const mindmapCode = historyResponse.mindmap_data.mindmap_svg || historyResponse.mindmap_data.mindmap_code;
        if (mindmapCode) {
          renderMindmap(mindmapCode.trim());
        }
      }
      
      // 12. æ›´æ–°å…¨å±€æ•¸æ“š
      window.generatedDocxData = {
        university: historyResponse.university,
        department: historyResponse.department,
        section_code: historyResponse.section_code,
        generated_text: historyResponse.generated_text,
        mindmap_data: historyResponse.mindmap_data,
        style: historyResponse.style
      };
      
      hideLoading();
      showSuccessToast('âœ… æ­·å²è¨˜éŒ„è¼‰å…¥æˆåŠŸ');
      
    } catch (error) {
      console.error('è¼‰å…¥æ­·å²è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      hideLoading();
      showErrorToast('è¼‰å…¥å¤±æ•—ï¼š' + (error.message || 'è«‹ç¨å¾Œå†è©¦'));
      
      // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œç­‰å¾… 2 ç§’å¾Œé‡å®šå‘å›æœƒå“¡ä¸­å¿ƒ
      setTimeout(() => {
        window.location.href = '/profile';
      }, 2000);
    }
  }

  // åˆå§‹åŒ– Monaco Editor
  require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' }});
  require(['vs/editor/editor.main'], function() {
    window.mindmapEditor = monaco.editor.create(document.getElementById('mindmap-editor'), {
      value: 'mindmap\n  root((ä¸»é¡Œ))\n    branch1[åˆ†æ”¯1]\n      sub1[å­é …ç›®1]\n      sub2[å­é …ç›®2]\n    branch2[åˆ†æ”¯2]\n      sub3[å­é …ç›®3]',
      language: 'markdown',
      theme: 'vs-light',
      minimap: { enabled: false },
      lineNumbers: 'on',
      scrollBeyondLastLine: false,
      automaticLayout: true
    });
  });

  // ä¿®æ”¹è¼‰å…¥æ­·å²è¨˜éŒ„çš„é¡¯ç¤ºæ–¹å¼
  function displayHistoryContent(historyResponse) {
    // æ¸…ç©ºä¹‹å‰çš„å…§å®¹
    $("#output").empty();
    $("#mindmap-content").empty();
    $("#mindmap-container").hide();
    
    // å¦‚æœæœ‰å¿ƒæ™ºåœ–ï¼Œé¡¯ç¤ºåœ¨é ‚éƒ¨
    if (historyResponse.mindmap_data) {
      const mindmapCode = historyResponse.mindmap_data.mindmap_svg || historyResponse.mindmap_data.mindmap_code;
      if (mindmapCode) {
        renderMindmap(mindmapCode);
      }
    }

    // é¡¯ç¤ºç”Ÿæˆçš„æ®µè½
    const blocks = historyResponse.generated_text.split(/\n{2,}/);
    blocks.forEach((block, idx) => {
      const trimmed = block.trim();
      if (!trimmed) return;

      const isTable = trimmed.includes("<table");
      let contentHtml = isTable
        ? trimmed
        : `<p>${trimmed.replace(/\n/g, "<br>")}</p>`;

      $("#output").append(`
        <div class="paragraph-card" id="paragraph-${idx}">
          <div class="paragraph-header">
            <span>ğŸ“„ æ®µè½ ${idx + 1}</span>
            ${!isTable ? 
              `<button class="btn btn-outline-primary btn-sm" onclick="regenerateParagraph(${idx})">
                ğŸ”„ é‡æ–°ç”Ÿæˆ
              </button>` : 
              ''}
          </div>
          <div class="paragraph-body">
            ${contentHtml}
          </div>
        </div>
      `);
    });

    // ä¿å­˜åˆ°å…¨å±€è®Šé‡
    window.generatedDocxData = {
      university: historyResponse.university,
      department: historyResponse.department,
      section_code: historyResponse.section_code,
      generated_text: historyResponse.generated_text,
      mindmap_data: historyResponse.mindmap_data,
      style: historyResponse.style
    };

    $("#download-docx").show();
  }

  // æ·»åŠ äº‹ä»¶ç›£è½å™¨
  document.addEventListener('DOMContentLoaded', function() {
    // é—œé–‰å¿ƒæ™ºåœ–æ¨¡æ…‹æ¡†
    const modal = document.getElementById('mindmapModal');
    const closeBtn = document.querySelector('.mindmap-close');
    
    closeBtn.onclick = function() {
      modal.style.display = 'none';
    }
    
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
    
    // å¿ƒæ™ºåœ–ç¸®æ”¾åŠŸèƒ½
    document.querySelectorAll('.mindmap-container').forEach(container => {
      container.addEventListener('click', function() {
        this.classList.toggle('zoomed');
      });
    });
  });

  // æ·»åŠ èª¿è©¦å‡½æ•¸
  function checkMindmapData() {
    const container = document.getElementById('mindmap-content');
    console.log('å¿ƒæ™ºåœ–å®¹å™¨å…§å®¹:', container.innerHTML);
    console.log('å¿ƒæ™ºåœ–å®¹å™¨å¯è¦‹æ€§:', $("#mindmap-container").is(":visible"));
    const mermaidElements = document.querySelectorAll('.mermaid');
    console.log('Mermaid å…ƒç´ æ•¸é‡:', mermaidElements.length);
    mermaidElements.forEach((el, i) => {
      console.log(`Mermaid å…ƒç´  ${i} å…§å®¹:`, el.textContent);
    });
  }

  // åœ¨ç”Ÿæˆå®Œæˆå¾Œæª¢æŸ¥
  $(document).ajaxComplete(function(event, xhr, settings) {
    if (settings.url === "/generate_mindmap") {
      setTimeout(checkMindmapData, 1000);
    }
  });

  // æ·»åŠ å…¨å±€éŒ¯èª¤è™•ç†
  window.addEventListener('error', function(event) {
    if (event.error && event.error.toString().includes('mermaid')) {
      console.error('Mermaid éŒ¯èª¤:', event.error);
      // é˜²æ­¢éŒ¯èª¤ä¸­æ–·ç·¨è¼¯å™¨åŠŸèƒ½
      event.preventDefault();
    }
  });
</script>

{% endblock %}
